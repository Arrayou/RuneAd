<div class="card border-0 shadow-sm overflow-hidden mb-2">
    <div class="card-header bg-primary text-white py-3">
        Runescape Private Servers
    </div>

    {% set start_rank = servers.firstItem() %}

    <table class="table mb-0" style="line-height:1em;">
        <thead>
            <tr class="bg-{{ theme == "dark" ? "dark" : "secondary" }}">
                <th class="text-center py-2 small border-0">Rank</th>
                <th class="py-2 small border-0">Server</th>
                <th class="py-2 small border-0 px-0 d-none d-lg-table-cell"
                    style="width:100px;"></th>
                <th class="py-2 border-0">&nbsp;</th>
            </tr>
        </thead>
        {% for server in servers.items() %}
        {% set server_url = friendlyTitle(server.id~' '~server.title) %}

        {% set class = server.premium_expires > time() ? 'bg-primary' : '' %}

        <tr id="server" class="{{ class }}">
            <td class="text-center rank-col">
                {{ start_rank }}
            </td>

            <td class="py-4">
                {% if server.revision %}
                    <div class="badge badge-primary float-left mr-2">
                        {{ server.revision }}
                    </div>
                {% endif %}

                <a href="{{ url('details/'~server_url) }}">
                    {% if server.title|length > 40 %}
                    {{ substr(server.title, 0, 40)~'...' }}
                    {% else %}
                    {{ server.title }}
                    {% endif %}
                </a>

                {% if server.banner_url %}
                <a href="{{ url('details/'~server_url) }}" class="banner-img">
                    <img data-src="{{ banner(server.banner_url) }}"
                    src="{{ url('public/img/banner-loading.png') }}"
                        id="banner"
                        alt="{{ server.banner_url }}"
                        style="margin-top:14px;"
                        class="img-fluid rounded lazy">
                </a>
                {% else %}
                <a href="{{ url('details/'~server_url) }}" class="banner-img">
                    <img src="{{ url('public/img/banner-'~theme~'.png') }}"
                        id="banner"
                        alt="{{ url('public/img/banner-'~theme~'.png') }}"
                        style="margin-top:14px;"
                        class="img-fluid rounded lazy">
                </a>
                {% endif %}
            </td>

            <td class="d-none d-lg-table-cell small">
                {% if server.ping == -1  %}
                <span class="badge badge-danger status-badge"
                    data-toggle="tooltip" data-title="{{ elapsed(server.last_ping) }}">
                    Offline
                </span>
                {% else %}
                <span class="badge badge-success status-badge"
                    data-toggle="tooltip" data-title="{{ elapsed(server.last_ping) }}">
                    Online
                </span>
                {% endif %}
            </td>

            <td class="text-right">
                {% set btnclass = server.premium_expires > time()
                    and theme == "dark" ? 'btn-primary' : 'btn-primary' %}

                <div class="d-flex align-items-center justify-content-end">
                    <div class="pr-3">
                        <p class="mb-0" id="votes">{{ server.votes|number_format }}</p>
                        <span class="small text-muted mb-0">Votes</span>
                    </div>
                    {% if is_mobile == false %}
                    <div class="pr-1 d-none d-lg-flex">
                        <a href="{{ url('vote/'~server_url) }}" rel="nofollow"
                        data-toggle="tooltip"
                        data-title="Vote"
                            data-id="{{ server.id }}" class="btn {{ btnclass }} vote-btn">
                            {{ icon('check2-square', 16, 16) }}
                        </a>
                    </div>
                    {% endif %}
                    <div class="">
                    <a href="{{ server.website }}"
                      data-toggle="tooltip"
                      data-title="Website"
                      target="_blank" rel="nofollow"
                            data-id="{{ server.id }}"
                            class="btn btn-primary float-right {{ server.website ? '' : 'disabled' }}">
                             {{ icon('link-45deg', 16, 16) }}
                         </a>
                    </div>
                </div>
            </td>
        </tr>
        {% set start_rank = start_rank + 1 %}
        {% else %}
        <tr>
            <td colspan=5 class="p-4">Nothing to see here.</td>
        </tr>
        {% endfor %}
    </table>
</div>

<p class="small text-muted">
    Status updates occur every 30 minutes on the clock. (ie 9, 9:30, 10, 10:30, etc.)
</p>
<p class="small text-muted">
    Votes Reset in <p id="demo"></p>
</p>

{% set totalPages = servers.lastPage() %}
{% set current = servers.currentPage() %}

{% set pageUrl = revision is defined ? url('rev-'~revision.revision~'/') : url('')  %}


<nav aria-label="servernav" class="mt-5">
    <ul class="pagination justify-content-center">
        <li class="page-item {{ servers.onFirstPage() ? 'disabled' : '' }}">
            <a class="page-link"
                 href="{{ pageUrl~'1' }}" tabindex="-1">
                 {{ icon('chevron-bar-left', 14, 14) }}
            </a>
        </li>

        <li class="page-item {{ servers.onFirstPage() ? 'disabled' : '' }}">
            <a class="page-link"
                href="{{ pageUrl ~ (current == 1 ? 1 : current - 1) }}" tabindex="-1">
                {{ icon('chevron-left', 14, 14) }}
            </a>
        </li>

        {% if totalPages > 5 %}
            {% set start = current < 3 ? 1 : current - 2 %}
            {% set end   = start < 4 ? start + 4 : current + 2 %}

            {% if end > totalPages %}
                {% set end = totalPages %}
            {% endif %}

            {% if start + 4 >= totalPages %}
                {% set start = totalPages - 4 %}
            {% endif %}
        {% else %}
            {% set start = 1 %}
            {% set end   = servers.lastPage() %}
        {% endif %}

        {% for p in start..end %}
        <li class="page-item {{ current == p ? ' active' : ''}}">
            <a class="page-link" href="{{ pageUrl ~ p }}">
                {{ p }}
            </a>
        </li>
        {% endfor %}

        <li class="page-item {{ current >= totalPages ? 'disabled' : '' }}">
            <a class="page-link"
                href="{{ pageUrl~(current == totalPages ? totalPages : current + 1) }}">
                {{ icon('chevron-right', 14, 14) }}
            </a>
        </li>

        <li class="page-item {{ current >= totalPages ? 'disabled' : '' }}">
            <a class="page-link"
                href="{{ pageUrl ~ totalPages }}">
                 {{ icon('chevron-bar-right', 14, 14) }}
            </a>
        </li>
    </ul>
</nav>

{% if is_mobile == false %}
{% set recaptcha_key = constant('recaptcha')['public'] %}

<script src="https://www.google.com/recaptcha/api.js?render={{ recaptcha_key }}" async></script>

<script>
// Set the date we're counting down to
var countDownDate = new Date("Sep 1, 2020 24:00:00").getTime();

// Update the count down every 1 second
var x = setInterval(function() {

  // Get today's date and time
  var now = new Date().getTime();

  // Find the distance between now and the count down date
  var distance = countDownDate - now;

  // Time calculations for days, hours, minutes and seconds
  var days = Math.floor(distance / (1000 * 60 * 60 * 24));
  var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  var seconds = Math.floor((distance % (1000 * 60)) / 1000);

  // Output the result in an element with id="demo"
  document.getElementById("demo").innerHTML = days + "d " + hours + "h "
  + minutes + "m " + seconds + "s ";

  // If the count down is over, write some text
  if (distance < 0) {
    clearInterval(x);
    document.getElementById("demo").innerHTML = "EXPIRED";
  }
}, 1000);
</script>

<script>
document.addEventListener('DOMContentLoaded', function(event) {
    let locked = false;
    $('.vote-btn').click(function(event) {
        event.preventDefault();
        locked = true;

        let btn = $(this);
        let txt = $(this).text();
        let id  = $(this).data("id");

        btn.html('{{ icon("three-dots", 16, 16) }}');
        btn.addClass("disabled");
        btn.removeClass("btn-success btn-danger").addClass("btn-primary");
        grecaptcha.ready(function() {
            grecaptcha.execute("{{ recaptcha_key }}", {
                action: 'homepage'
            }).then(function(token) {
                $.ajaxq('VoteQueue', {
                    url: '{{ url("servers/addvote") }}',
                    data: {
                        server_id: id,
                        token: token
                    },
                    type: 'POST',
                    complete: function (data) {

                    },
                    success: function (json) {
                        if (json.success) {
                            let votes = json.votes;
                            let votecnt = btn.closest("td").find("#votes");
                            votecnt.html(votes);
                        }

                        btn.removeClass("btn-primary btn-danger btn-success")
                            .addClass("btn-"+(json.success ? 'success' : 'danger'));

                            btn.html(json.success
                                  ? '{{ icon("check", 16, 16) }}'
                                  : '{{ icon("x", 16, 16) }}');

                        setTimeout(function() {
                            btn.removeClass("btn-primary btn-danger disabled")
                                .addClass("btn-primary");
                            btn.html('{{ icon("check2-square", 16, 16) }}');
                            locked = false;
                        }, 1000);
                    },
                    error: function(data) {
                        locked = false;
                        console.log(data.responseText);
                    }
                });
            });
        });
    });
});
</script>
{% endif %}
